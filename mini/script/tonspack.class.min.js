class Tonspack{constructor(e,t){if(e){this.uuid=e}else{this.uuid=crypto.randomUUID()}if(t?.baseurl){this.baseurl=t.baseurl}else{this.baseurl="https://pack.tons.ink/api"}if(t?.actionUrl){this.actionUrl=t.actionUrl}else{this.actionUrl="https://t.me/tonspack_bot/connect?startapp="}if(t?.loopInterval){this.loopInterval=t.loopInterval}else{this.loopInterval=500}if(t?.loopTimeout){this.loopTimeout=t.loopTimeout}else{this.loopTimeout=120}this.encryptionKp=nacl.box.keyPair()}encode(s,c){try{let e=nacl.box.keyPair();let t=Buffer.from(c);let o=nacl.randomBytes(nacl.box.nonceLength);let r=nacl.box(t,o,s,e.secretKey);let n=Buffer.from(o).toString("base64");let i=Buffer.from(e.publicKey).toString("base64");let a=Buffer.from(r).toString("base64");return{nonce:n,ephemPubKey:i,encrypted:a}}catch(e){return false}}decode(e,t){try{const o=nacl.box.open(new Uint8Array(Buffer.from(t.encrypted,"base64")),new Uint8Array(Buffer.from(t.nonce,"base64")),new Uint8Array(Buffer.from(t.ephemPubKey,"base64")),e);return Buffer.from(o).toString("utf8")}catch(e){return false}}async loopCheck(){for(var e=0;e<this.loopTimeout;e++){const t=await this.check_request_action();if(t?.data){try{let e=JSON.parse(t.data);{if(e?.nonce&&e?.ephemPubKey&&e?.encrypted){return this.decode(this.encryptionKp.secretKey,e)}return t.data}}catch(e){return t.data}}await this.sleep(this.loopInterval)}return{status:false,reason:"user operation timeout"}}async sleep(t){return new Promise(e=>{setTimeout(e,t)})}async check_request_action(){try{return(await fetch(this.baseurl+"/result/"+this.uuid,{method:"GET",headers:{},redirect:"follow"})).json()}catch(e){console.error(e);return false}}async connect(e,t){const o=window.location.origin;const r={t:0,i:this.uuid,d:o,c:e,r:t||null,k:Buffer.from(this.encryptionKp.publicKey).toString("base64")};window.open(this.actionUrl+base58.encode(Buffer.from(JSON.stringify(r))),"newwindow","height=800, width=400, toolbar=no, menubar=no, scrollbars=no, resizable=no, location=no, status=no");return await this.loopCheck()}async sign(e,t,o,r){var n={t:1,i:this.uuid,d:t,c:e,r:o||null,k:Buffer.from(this.encryptionKp.publicKey).toString("base64")};if(r){var i=new Headers;i.append("Content-Type","application/json");var a={method:"POST",headers:i,body:JSON.stringify({data:base58.encode(Buffer.from(JSON.stringify(n)))}),redirect:"follow"};await fetch(`${this.baseurl}/preconnect/${n.i}`,a);n={i:this.uuid,p:1}}window.open(this.actionUrl+base58.encode(Buffer.from(JSON.stringify(n))),"newwindow","height=800, width=400, toolbar=no, menubar=no, scrollbars=no, resizable=no, location=no, status=no");return await this.loopCheck()}async send(e,t,o,r){var n={t:2,i:this.uuid,d:t,c:e,r:o||null,k:Buffer.from(this.encryptionKp.publicKey).toString("base64")};if(r){var i=new Headers;i.append("Content-Type","application/json");var a={method:"POST",headers:i,body:JSON.stringify({data:base58.encode(Buffer.from(JSON.stringify(n)))}),redirect:"follow"};await fetch(`${this.baseurl}/preconnect/${n.i}`,a);n={i:this.uuid,p:1}}window.open(this.actionUrl+base58.encode(Buffer.from(JSON.stringify(n))),"newwindow","height=800, width=400, toolbar=no, menubar=no, scrollbars=no, resizable=no, location=no, status=no");return await this.loopCheck()}}