<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Tonspack Demo</title>
    <style>
        .container {
            width: 60%;
            margin: 1% auto 0;
            background-color: #f0f0f0;
            padding: 2% 5%;
            border-radius: 10px
        }

        ul {
            padding-left: 20px;
        }

            ul li {
                line-height: 2.3
            }

        a {
            color: #20a53a
        }
    </style>
</head>
<body>
    <h1 style="text-align: center;">Tonspack mini demo</h1>
    <div class="container">
        <h1>connect wallet</h1>
        <h3 id = 'connect_context'></h3>
        <ul>
            <li>
                <button onclick="connect_evm()"> Connect to ARB </button>
            </li>
            <li><button onclick="connect_sol()"> Connect to SOL </button>
            <li><button onclick="connect_ton()"> Connect to TON </button>
        </ul>
    </div>

    <div class="container">
        <h1>sign message</h1>
        <input id="presign_message"  placeholder="Input presign message" style="width: 50%;">
        <h3 id = 'sign_context'></h3>
        <ul>
            <li>
                <button onclick="sign_evm()"> EVM sign message </button>
            </li>
            <li>
                <button onclick="sign_sol()"> SOL sign message </button></li>
            <li><button onclick="sign_ton()"> TON sign message </button></li>
        </ul>
    </div>


    <div class="container">
        <h1>send transaction</h1>
        <h3 id = 'transaction_context'></h3>
        <ul>
            <li>
                <button> EVM send txn </button>
            </li>
            <li>
                <button> SOL send txn </button></li>
            <li>
                <button> TON send txn </button></li>
        </ul>
    </div>
    <!-- Base require script -->
    <!-- *JS base58 -->
    <script src="./script/jsbn.js"></script>
    <script src="./script/jsbn2.js"></script>
    <script src="./script/base58.js"></script>

    <script src="https://bundle.run/buffer@6.0.3"></script>
    <!-- *JS buffer -->
    <script type="text/javascript">
        window.Buffer = window.Buffer ?? buffer.Buffer;
    </script>
    <!-- *JS main -->
    <script>
        console.log(
            base58.encode( Buffer.from("https://t.me/tonspack_bot/connect?startapp="))
        )
        class Tonspack{
            constructor(uuid,config)
            {
                if(uuid)
                {
                    this.uuid = uuid
                }else{
                    this.uuid = crypto.randomUUID();
                }

                if(config?.baseurl)
                {
                    this.baseurl = config.baseurl
                }else{
                    this.baseurl = "https://pack.tons.ink/api"
                }

                if(config?.actionUrl)
                {
                    this.actionUrl = config.actionUrl
                }else{
                    this.actionUrl = 'https://t.me/tonspack_bot/connect?startapp='
                }

                if(config?.loopInterval)
                {
                    this.loopInterval = config.loopInterval
                }else{
                    this.loopInterval = 500 //0.5
                }

                if(config?.loopTimeout)
                {
                    this.loopTimeout = config.loopTimeout
                }else{
                    this.loopTimeout = 120 //1min
                }
            }

            async loopCheck() {
                for(var i = 0 ; i < this.loopTimeout ; i++)
                {
                    const ret = await this.check_request_action()
                    console.log(ret)
                    if(ret.data)
                    {
                        return ret.data
                    }
                    await this.sleep(this.loopInterval)
                }
                return {
                    status:false,
                    reason:"user operation timeout"
                }
            }

            async sleep (ms) {
                return new Promise((resolve) => {
                setTimeout(resolve, ms);
                });
            }
            async check_request_action(){
                try{
                    return (await fetch(this.baseurl+'/result/'+this.uuid,{
                        method: "GET",
                        headers: {},
                        redirect: 'follow'
                    })).json()
                }catch(e)
                {
                    console.error(e)
                    return false;
                }
            }

            async connect(chian,redirect) {
                const site = window.location.origin
                
                const d =  {
                                t:0,
                                i:this.uuid, 
                                d:site, 
                                c:chian, 
                                r:redirect || null
                            }

                window.open(this.actionUrl+base58.encode(Buffer.from(JSON.stringify(d))),"newwindow","height=800, width=400, toolbar=no, menubar=no, scrollbars=no, resizable=no, location=no, status=no");
                return await this.loopCheck()
            }

            async sign(chian,sign,redirect) {
                const d =  {
                                t:1,
                                i:this.uuid, 
                                d:sign, 
                                c:chian, 
                                r:redirect || null
                            }
                window.open(this.actionUrl+base58.encode(Buffer.from(JSON.stringify(d))),"newwindow","height=800, width=400, toolbar=no, menubar=no, scrollbars=no, resizable=no, location=no, status=no");
                return await this.loopCheck()
            }
        }

        async function connect_evm()
        {
            var pack = new Tonspack();
            console.log('pack.uuid',pack.uuid)
            var connect = await pack.connect({t:0,i:1})
            console.log("connect",connect)
            document.getElementById('connect_context').innerHTML = connect
        }

        async function connect_sol()
        {
            var pack = new Tonspack();
            console.log('pack.uuid',pack.uuid)
            var connect = await pack.connect({t:1,i:1})
            console.log("connect",connect)
            document.getElementById('connect_context').innerHTML = connect
        }

        async function connect_ton()
        {
            var pack = new Tonspack();
            console.log('pack.uuid',pack.uuid)
            var connect = await pack.connect({t:2,i:1})
            console.log("connect",connect)
            document.getElementById('connect_context').innerHTML = connect
        }

        async function sign_evm()
        {
            var pack = new Tonspack();
            console.log('pack.uuid',pack.uuid)
            var sign = await pack.sign({t:0,i:1},document.getElementById("presign_message").value)
            console.log("sign",sign)
            document.getElementById('sign_context').innerHTML = sign
        }
        async function sign_sol()
        {
            var pack = new Tonspack();
            console.log('pack.uuid',pack.uuid)
            var sign = await pack.sign({t:1,i:1},document.getElementById("presign_message").value)
            console.log("sign",sign)
            document.getElementById('sign_context').innerHTML = sign
        }
        async function sign_ton()
        {
            var pack = new Tonspack();
            console.log('pack.uuid',pack.uuid)
            var sign = await pack.sign({t:2,i:1},document.getElementById("presign_message").value)
            console.log("sign",sign)
            document.getElementById('sign_context').innerHTML = sign
        }
        
    </script>
</body>
</html>