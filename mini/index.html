<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Tonspack Demo</title>
    <style>
        .container {
            width: 60%;
            margin: 1% auto 0;
            background-color: #f0f0f0;
            padding: 2% 5%;
            border-radius: 10px
        }

        ul {
            padding-left: 20px;
        }

            ul li {
                line-height: 2.3
            }

        a {
            color: #20a53a
        }
    </style>
</head>
<body>
    <h1 style="text-align: center;">Tonspack mini demo</h1>
    <div class="container">
        <h1>connect wallet</h1>
        <h3 id = 'connect_context'></h3>
        <ul>
            <li>
                <button onclick="connect_evm()"> Connect to ARB </button>
            </li>
            <li><button onclick="connect_sol()"> Connect to SOL </button>
            <li><button onclick="connect_ton()"> Connect to TON </button>
              <li>
                <button onclick="connect_btc()"> Connect to Bitcoin </button>
            </li>
        </ul>
    </div>

    <div class="container">
        <h1>sign message</h1>
        <input id="presign_message"  placeholder="Input presign message" style="width: 50%;">
        <h3 id = 'sign_context'></h3>
        <ul>
            <li>
                <button onclick="sign_evm()"> ARB sign message </button>
            </li>
            <li>
                <button onclick="sign_sol()"> SOL sign message </button></li>
            <li><button onclick="sign_ton()"> TON sign message </button></li>

            <li>
              <button onclick="sign_btc()"> Sign BitcoinMessage </button>
          </li>
        </ul>
    </div>


    <div class="container">
        <h1>send transaction</h1>
        <h3 id = 'transaction_context'></h3>
        <ul>
            <li>
                <button onclick="send_evm()"> tBsc send txn </button>
            </li>
            <li>
                <button onclick="send_sol()"> SOL send txn </button></li>
            <li><button onclick="send_ton()"> TON send txn </button></li>
            <li><button onclick="send_btc()"> Bitcoin send txn </button></li>
        </ul>
    </div>

    <div class="container">
        <h1>Contract Send</h1>
        <h3 id = 'contract_context'></h3>
        <ul>
            <li>
                <button onclick="contract_evm()"> tBsc contract send </button>
            </li>
            <li>
                <button onclick="window.open('https://t.me/Tonspack_bot/gate?startapp=25K6n8x9BaUPfne6zFhSW9B5S9ZerNX5aeytN78')"> SOL contract send </button></li>
            <li>
                <button> TON contract send </button></li>
        </ul>
    </div>
    <!-- Base require script -->
    <!-- *JS base58 -->
    <!-- <script src="./script/jsbn.js"></script>
    <script src="./script/jsbn2.js"></script>
    <script src="./script/base58.js"></script> -->
    <script src="./script/tonspack.full.min.js"></script>

    <script src="https://bundle.run/buffer@6.0.3"></script>
    <!-- *JS buffer -->
    <script type="text/javascript">
        window.Buffer = window.Buffer ?? buffer.Buffer;
    </script>
            <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
            <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
    <!-- *JS main -->
    <script>


        var adds ={
            evm:""
        }
        async function connect_evm()
        {
            var pack = new Tonspack();
            console.log('pack.uuid',pack.uuid)
            var connect = await pack.connect({t:0,i:42161})
            console.log("connect",connect)
            document.getElementById('connect_context').innerHTML = connect
            adds.evm = connect
        }

        async function connect_sol()
        {
            var pack = new Tonspack();
            console.log('pack.uuid',pack.uuid)
            var connect = await pack.connect({t:1,i:1})
            console.log("connect",connect)
            document.getElementById('connect_context').innerHTML = connect
        }

        async function connect_ton()
        {
            var pack = new Tonspack();
            console.log('pack.uuid',pack.uuid)
            var connect = await pack.connect({t:2,i:1})
            console.log("connect",connect)
            document.getElementById('connect_context').innerHTML = connect
        }
        async function connect_ton()
        {
            var pack = new Tonspack();
            console.log('pack.uuid',pack.uuid)
            var connect = await pack.connect({t:3,i:0})
            console.log("connect",connect)
            document.getElementById('connect_context').innerHTML = connect
        }

        async function sign_evm()
        {
            var pack = new Tonspack();
            console.log('pack.uuid',pack.uuid)
            var sign = await pack.sign({t:0,i:42161},document.getElementById("presign_message").value,"",true)
            console.log("sign",sign)
            document.getElementById('sign_context').innerHTML = sign
        }
        async function sign_sol()
        {
            var pack = new Tonspack();
            console.log('pack.uuid',pack.uuid)
            var sign = await pack.sign({t:1,i:1},document.getElementById("presign_message").value,"",true)
            console.log("sign",sign)
            document.getElementById('sign_context').innerHTML = sign
        }
        async function sign_ton()
        {
            var pack = new Tonspack();
            console.log('pack.uuid',pack.uuid)
            var sign = await pack.sign({t:2,i:1},document.getElementById("presign_message").value,"",true)
            console.log("sign",sign)
            document.getElementById('sign_context').innerHTML = sign
        }
        async function sign_btc()
        {
            var pack = new Tonspack();
            console.log('pack.uuid',pack.uuid)
            var sign = await pack.sign({t:3,i:1},document.getElementById("presign_message").value,"",true)
            console.log("sign",sign)
            document.getElementById('sign_context').innerHTML = sign
        }
        

        async function send_evm()
        {
            var chain = {t:0,i:97} //tbsc
            var txns = {
                t:"0xe88C20f656dE083F593D172e8cF7C5d0Fd2E07A5",
                v:"100000"
            }
            var pack = new Tonspack();
            console.log('pack.uuid',pack.uuid)
            var txn = await pack.send(chain,txns,"",true)
            console.log("sendtxn",txn)
            document.getElementById('transaction_context').innerHTML = txn
        }

        async function send_btc()
        {
            var chain = {t:3,i:0} //tbsc
            var txns = {
                t:"159trGW9CKjt6pxcP5BwXJQPyd8Dx9yQr6",
                v:"100000"
            }
            var pack = new Tonspack();
            console.log('pack.uuid',pack.uuid)
            var txn = await pack.send(chain,txns,"",true)
            console.log("sendtxn",txn)
            document.getElementById('transaction_context').innerHTML = txn
        }


        async function send_sol()
        {
          var chain = {t:1,i:0} //solana
          var pack = new Tonspack();
          var connect = await pack.connect({t:1,i:1})
          if(connect)
          {
            var txns = await solana_txn_generate(connect,connect,"Hello world") 
            console.log('pack.txns',txns)
            var pack = new Tonspack();
            var txn = await pack.send(chain,txns,"",true)
            txn = JSON.parse(txn)
            console.log("sendtxn",txn)
            let sol_rpc_url = "https://mainnet.helius-rpc.com/?api-key=a32e6052-b2ed-491f-9521-ac6df5e9665a"
            const connection = new solanaWeb3.Connection(sol_rpc_url);

            var rawData = Buffer.from(txn[0],'base64');
            console.log(rawData)
            var tx = solanaWeb3.Transaction.from(rawData)
            console.log(tx)
            var ret = await connection.sendRawTransaction(
              tx.serialize(),
              {
                skipPreflight: true,
                maxRetries: 3
              }
            )
            console.log(ret)
            document.getElementById('transaction_context').innerHTML = ret
          }

        }

        async function contract_evm()
        {
            var chain = {t:0,i:97} //tbsc

            var pack = new Tonspack();
            // var add = await pack.connect(chain);
            if(true)
            {
                //Connect wallet to get the user address

                window.web3 = new Web3(window.ethereum);
                var ct = await load_contract('0x263aD853F020075De3FC1D3e24e9d8E88BcD9182')
                console.log(ct)
                const cts = await ct.methods.transfer(
                    '0xe88C20f656dE083F593D172e8cF7C5d0Fd2E07A5' , 
                    "10000000",
                    '2jnass')
                console.log(cts)
                const data = (cts.encodeABI());

                var txns = {
                    t:"0x263aD853F020075De3FC1D3e24e9d8E88BcD9182",
                    v:"10000000",
                    d:data
                }
                console.log('taw txns : ',txns)
                var txn = await pack.send(chain,txns,true)
                console.log("sendtxn",txn)
                document.getElementById('contract_context').innerHTML = txn
            }

        }


        async function solana_txn_generate(from,to,message)
{
  let sol_rpc_url = "https://mainnet.helius-rpc.com/?api-key=a32e6052-b2ed-491f-9521-ac6df5e9665a"
  const connection = new solanaWeb3.Connection(sol_rpc_url);
  var transaction = new solanaWeb3.Transaction()


  var paymentTx = false;
    //SOL transfer
    console.log("ðŸš§ SOL transfer")
    paymentTx = solanaWeb3.SystemProgram.transfer({
      fromPubkey: new solanaWeb3.PublicKey(from),
      toPubkey: new solanaWeb3.PublicKey(to),
      lamports: 1
    })

  if(!paymentTx)
  {
    window.alert("ðŸš§ ERROR During TX constructing")
  }
  transaction.add(
    paymentTx
  )
    //Noticed transaction transfer 
  transaction.add(
      solanaWeb3.SystemProgram.transfer({
        fromPubkey: new solanaWeb3.PublicKey(from),
        toPubkey: new solanaWeb3.PublicKey(to),
          lamports: (1)
      }),
  );

    //Message transaction transfer 
  transaction.add(
      new solanaWeb3.TransactionInstruction({
          keys: [{ pubkey: new solanaWeb3.PublicKey(from), isSigner: true, isWritable: true }],
          data: Buffer.from(message, "utf-8"),
          programId: new solanaWeb3.PublicKey("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),
        })
  );
//   transaction.add(
//     solanaWeb3.ComputeBudgetProgram.setComputeUnitLimit({ 
//   units: 100000 
// })
// )
// transaction.add(
//   solanaWeb3.ComputeBudgetProgram.setComputeUnitPrice({ 
//   microLamports: 200000
// })
// )



//   const modifyComputeUnits = solanaWeb3.ComputeBudgetProgram.setComputeUnitLimit({ 
//   units: 1000 
// });
// transaction.add(
//   modifyComputeUnits
// )

// const addPriorityFee = solanaWeb3.ComputeBudgetProgram.setComputeUnitPrice({ 
//   microLamports: 200000
// });

// transaction.add(
//   addPriorityFee
// )


  transaction.feePayer =  new solanaWeb3.PublicKey(from);
  let blockhashObj = await connection.getRecentBlockhash();
  transaction.recentBlockhash = await blockhashObj.blockhash;
  return JSON.stringify(
    [
      {
        t:0,
        d:base58.encode(
        await transaction.serializeMessage()
      )
      }
    ]
  );
}
    

        async function load_contract(contract) {
    return await new window.web3.eth.Contract([
      {
        "inputs": [],
        "stateMutability": "nonpayable",
        "type": "constructor"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": false,
            "internalType": "string",
            "name": "id",
            "type": "string"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "from",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "originFrom",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "to",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "amount",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "amountFinal",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "amountRouter",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "bool",
            "name": "isPrepaid",
            "type": "bool"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "time",
            "type": "uint256"
          }
        ],
        "name": "pay",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": false,
            "internalType": "string",
            "name": "id",
            "type": "string"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "from",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "originFrom",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "to",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "amount",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "amountFinal",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "amountRouter",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "token",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "bool",
            "name": "isPrepaid",
            "type": "bool"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "time",
            "type": "uint256"
          }
        ],
        "name": "payToken",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": false,
            "internalType": "address",
            "name": "from",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "to",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "amount",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "time",
            "type": "uint256"
          }
        ],
        "name": "withdraw",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": false,
            "internalType": "address",
            "name": "from",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "to",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "amount",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "address",
            "name": "token",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "time",
            "type": "uint256"
          }
        ],
        "name": "withdrawToken",
        "type": "event"
      },
      {
        "inputs": [],
        "name": "owner",
        "outputs": [
          {
            "internalType": "address",
            "name": "",
            "type": "address"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "to",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "amount",
            "type": "uint256"
          },
          {
            "internalType": "string",
            "name": "id",
            "type": "string"
          }
        ],
        "name": "transfer",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "to",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "amount",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "routerAmount",
            "type": "uint256"
          },
          {
            "internalType": "address",
            "name": "token",
            "type": "address"
          },
          {
            "internalType": "string",
            "name": "id",
            "type": "string"
          }
        ],
        "name": "transferToken",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "to",
            "type": "address"
          },
          {
            "internalType": "address",
            "name": "token",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "amount",
            "type": "uint256"
          }
        ],
        "name": "withdrawTokens",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "to",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "amount",
            "type": "uint256"
          }
        ],
        "name": "withdraws",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ], contract);
}

    </script>
</body>
</html>